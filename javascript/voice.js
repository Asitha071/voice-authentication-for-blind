// hideElement('#progress');
hideElement('#environmentMessage');
hideElement('#vadMessage');
hideElement('#passphraseMessage');
hideElement('#acceptMessage');
hideElement('#rejectMessage');
hideElement('#authenticationComplete');
hideElement('#authenticationInComplete');
hideElement('#enrollmentComplete');

document.querySelector('#stopRecButton').classList.add('disabled');

var x = document.referrer;
console.log("The refferer of this page is : ", x);

var wavesurfer = WaveSurfer.create({
  container: '#waveform',
  waveColor: '#01BAB6',
  interact: false,
  cursorWidth: 0,
  barGap: 2,
  barHeight: 2,
  barWidth: 0,
  fillParent: true,
  forceDecode: true,
  plugins: [
    WaveSurfer.microphone.create()
  ]
});

wavesurfer.microphone.on('deviceReady', function (stream) {
  console.log('Device ready!', stream);
});
wavesurfer.microphone.on('deviceError', function (code) {
  console.warn('Device error: ' + code);
});

// start the microphone
wavesurfer.microphone.start();

// pause rendering
//wavesurfer.microphone.pause();

// resume rendering
//wavesurfer.microphone.play();

// stop visualization and disconnect microphone
//wavesurfer.microphone.stopDevice();

// same as stopDevice() but also clears the wavesurfer canvas
//wavesurfer.microphone.stop();

// destroy the plugin
//wavesurfer.microphone.destroy();

// create an audio in
mic = new p5.AudioIn();

// users must manually enable their browser microphone for recording to work properly!
mic.start();

// create a sound recorder
recorder = new p5.SoundRecorder();

// connect the mic to the recorder
recorder.setInput(mic);

// create an empty sound file that we will use to playback the recording
soundFile = new p5.SoundFile();

if (document.referrer == "http://localhost:8080/enroll") {
  // number of attempts for enrollment.
  var number_of_attempts = 3;
  console.log("number of attempts : ", number_of_attempts);
}
else {
  // number of attempts for enrollment.
  var number_of_attempts = 1;
  console.log("number of attempts : ", number_of_attempts);
}


// One-liner to resume playback when user interacted with the page.
document.querySelector('#startRecButton').addEventListener('click', function () {

  // For the background sound
  if (document.querySelector('#passphraseMessage').style.display == 'none') {
    showElement('#environmentMessage');

    console.log("You have started recording passphrase...");
    recorder.record(soundFile);
  } else {
    document.querySelector('#passphraseMessage').classList.add('green');;

    console.log("You have started recording the background...");
    recorder.record(soundFile);
  }

  document.querySelector('#startRecButton').classList.add('disabled');
  document.querySelector('#stopRecButton').classList.remove('disabled');
});

document.querySelector('#stopRecButton').addEventListener('click', function () {

  if (document.querySelector('#passphraseMessage').style.display == '') {

  document.querySelector('#stopRecButton').classList.add('disabled');
  document.querySelector('#passphraseMessage').classList.remove('green');

    hideElement("#passphraseMessage");
    showElement("#vadMessage");

    stopRecording();
  }
  // For the background sound
  else {
    document.querySelector('#startRecButton').classList.remove('disabled');
  document.querySelector('#stopRecButton').classList.add('disabled');

    hideElement("#environmentMessage");
    showElement("#vadMessage");

    stopBackgroundRecording();
  }

});

function stopRecording() {
  console.log("You have stopped recording...");
  recorder.stop(); // stop recorder, and send the result to soundFile

  console.log("Playing the audioifle now...");
  soundFile.play();

  // console.log("Saving the audio file now...");
  // p5.prototype.saveSound(soundFile, file_name); // save file

  console.log("Saving the SoundFile to a blob file ...");
  var soundBlob = soundFile.getBlob();

  // Now we can send the blob to a server...
  var xhr = new XMLHttpRequest();

  xhr.onreadystatechange = function () {
    if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
      
      console.log("samadara");
      console.log("xhr.resposne : ", xhr.response);

      if (xhr.response == "fail") {
        hideElement('#vadMessage');
        showElement('#rejectMessage');
        var accept = new SpeechSynthesisUtterance("Hit l to continue");
        window.speechSynthesis.speak(accept);


      } else if (xhr.response == "pass") {
        hideElement('#vadMessage');
        showElement('#acceptMessage');
        var reject = new SpeechSynthesisUtterance("Hit c to continue");
        window.speechSynthesis.speak(reject);

        number_of_attempts--;
        console.log("number of attempts : ", number_of_attempts);
      } else {
//         //staet here
// // list of languages is probably not loaded, wait for it
// if(window.speechSynthesis.getVoices().length == 0) {
// 	window.speechSynthesis.addEventListener('voiceschanged', function() {
// 		textToSpeech();
// 	});
// }
// else {
// 	// languages list available, no need to wait
// 	textToSpeech()
// }

// function textToSpeech() {
// 	// get all voices that browser offers
// 	var available_voices = window.speechSynthesis.getVoices();

// 	// this will hold an english voice
// 	var english_voice = '';

// 	// find voice by language locale "en-US"
// 	// if not then select the first voice
// 	for(var i=0; i<available_voices.length; i++) {
// 		if(available_voices[i].lang === 'en-US') {
// 			english_voice = available_voices[i];
// 			break;
// 		}
// 	}
// 	if(english_voice === '')
// 		english_voice = available_voices[0];

//   // new SpeechSynthesisUtterance object
  

  
// 	var utter = new SpeechSynthesisUtterance();
// 	utter.rate = 1;
// 	utter.pitch = 0.5;
// 	utter.text = '#passphraseMessage';
// 	utter.voice = english_voice;

// 	// event after text has been spoken
// 	utter.onend = function() {
// 		alert('Speech has finished');
// 	}

// 	// speak
// 	window.speechSynthesis.speak(utter);
// }



//         //end here
        showElement('#passphraseMessage');
        
        hideElement('#vadMessage');

        document.getElementById('randomPassphrase').innerHTML = xhr.response;
      }
    }
  }

  xhr.open("POST", "/voice", true);
  xhr.send(soundBlob);

  console.log("Your http message has been sent.");
}

function stopBackgroundRecording() {
  console.log("You have stopped recording...");
  recorder.stop(); // stop recorder, and send the result to soundFile

  console.log("Playing the audioifle now...");
  soundFile.play();

  // console.log("Saving the audio file now...");
  // p5.prototype.saveSound(soundFile, file_name); // save file

  console.log("Saving the SoundFile to a blob file ...");
  var soundBlob = soundFile.getBlob();

  // Now we can send the blob to a server...
  var xhr = new XMLHttpRequest();

  xhr.onreadystatechange = function () {
    if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
      
      showElement('#passphraseMessage');
     
   
      hideElement('#vadMessage');
      document.getElementById('randomPassphrase').innerHTML = xhr.response;
      
      console.log("xjr.resposne : ", xhr.response);
      var msg6 = new SpeechSynthesisUtterance(xhr.response);
      window.speechSynthesis.speak(msg6);
    }
  }

  xhr.open("POST", "/vad", true);
  xhr.send(soundBlob);

  number_of_attempts--;
  console.log("Your http message has been sent.");
  console.log("number of attempts : ", number_of_attempts);
  console.log("Asitha");
  var msg5 = new SpeechSynthesisUtterance("please hit y for start recording and n to stop recording and recite the following words");
  window.speechSynthesis.speak(msg5);
 
  console.log("madushanka");
}

document.querySelector('#close_button_accept').addEventListener('click', function () {
  if (number_of_attempts < 0) {
    console.log("number_of_attempts < 0");
    if (document.referrer == "http://localhost:8080/auth") {
      hideElement('#acceptMessage');
      showElement('#vadMessage');
      hideElement('#passphraseMessage');

      var analysis_text = 'Identifying user based on voice print';
      document.getElementById('recordBody').innerHTML = analysis_text;

      document.querySelector('#vadMessage').classList.add('green');
      document.querySelector('#vadMessage').classList.remove('yellow');

      var xhr = new XMLHttpRequest();

      xhr.onreadystatechange = function () {
        if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
          // showElement('#passphraseMessage');
          // hideElement('#vadMessage');
          // document.getElementById('randomPassphrase').innerHTML = xhr.response;
          console.log("xjr.resposne : ", xhr.response);

          if (xhr.response == "success") {
            showElement('#authenticationComplete');
            hideElement('#vadMessage');
          } 
          else if (xhr.response == "fail") {
            showElement('#authenticationInComplete');
            var msg9 = new SpeechSynthesisUtterance("hit h to go back to home page");
            window.speechSynthesis.speak(msg9);
            hideElement('#vadMessage');
          }
        } 
      }

      xhr.open("GET", "/verify", true);
      xhr.send();
    }
    else {
      console.log("number_of_attempts > 0");
      hideElement('#acceptMessage');
      showElement('#vadMessage');
      hideElement('#passphraseMessage');

      var analysis_text = 'Building Voice Print';
      document.getElementById('recordBody').innerHTML = analysis_text;

      document.querySelector('#vadMessage').classList.add('green');
      document.querySelector('#vadMessage').classList.remove('yellow');

      var xhr = new XMLHttpRequest();

      xhr.onreadystatechange = function () {
        if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
          // showElement('#passphraseMessage');
          hideElement('#vadMessage');
          // document.getElementById('randomPassphrase').innerHTML = xhr.response;
          console.log("xjr.resposne : ", xhr.response);

          showElement("#enrollmentComplete");
          var m = new SpeechSynthesisUtterance("hit aa to authenticate yourself right now");
          window.speechSynthesis.speak(m);
        }
      }

      xhr.open("GET", "/biometrics", true);
      xhr.send();
    }
  }
  else {
    // document.querySelector('#startRecButton').classList.remove('disabled');

//     hideElement('#acceptMessage');
//     showElement('#vadMessage');
//     hideElement('#passphraseMessage');

//     var xhr = new XMLHttpRequest();

//     xhr.onreadystatechange = function () {
//       if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
//         showElement('#passphraseMessage');
//         hideElement('#vadMessage');
//         document.getElementById('randomPassphrase').innerHTML = xhr.response;
//         // var msg5 = new SpeechSynthesisUtterance("please hit tab then enter and recite the following words");
//         // window.speechSynthesis.speak(msg5);
//         console.log("Asitha ");
//         console.log("xjr.resposne : ", xhr.response);
       
//       }
//     }

//     xhr.open("GET", "/vad", true);
//     xhr.send();
//   }
// });
document.querySelector('#startRecButton').classList.remove('disabled');

    hideElement('#acceptMessage');
    showElement('#vadMessage');
    hideElement('#passphraseMessage');

    var xhr = new XMLHttpRequest();

    xhr.onreadystatechange = function () {
      if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
        showElement('#passphraseMessage');
        hideElement('#vadMessage');
        document.getElementById('randomPassphrase').innerHTML = xhr.response;
        console.log("xjr.resposne : ", xhr.response);
        var msg20 = new SpeechSynthesisUtterance("please hit yy to start recording and nn to stop recording and recite the following words");
        window.speechSynthesis.speak(msg20);
        var msg21 = new SpeechSynthesisUtterance(xhr.response);
        window.speechSynthesis.speak(msg21);
      }
    }

    xhr.open("GET", "/vad", true);
    xhr.send();
  }
});

document.querySelector('#close_button_reject').addEventListener('click', function () {
  document.querySelector('#startRecButton').classList.remove('disabled');

  showElement('#vadMessage');
  hideElement('#rejectMessage');
  hideElement('#passphraseMessage');

  var xhr = new XMLHttpRequest();

 
  xhr.onreadystatechange = function () {
    if (xhr.readyState == XMLHttpRequest.DONE && xhr.status == 200) {
      
                
     
    
    
      showElement('#passphraseMessage');
      hideElement('#vadMessage');
      document.getElementById('randomPassphrase').innerHTML = xhr.response;
      console.log("xjr.resposne : ", xhr.response);
      var msg5 = new SpeechSynthesisUtterance("please hit yy to start recording and nn to stop recording and recite the following words");
      window.speechSynthesis.speak(msg5);
      var msg7 = new SpeechSynthesisUtterance(xhr.response);
      window.speechSynthesis.speak(msg7);
    }
  }

  xhr.open("GET", "/vad", true);
  xhr.send();
});

function hideElement(elSelector) {
  document.querySelector(elSelector).style.display = 'none';
}

function showElement(elSelector) {
  document.querySelector(elSelector).style.display = '';
  console.log("adiug");
  // var msg6 = new SpeechSynthesisUtterance('hello');
  // window.speechSynthesis.speak(msg6);

}
  


















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































